package com.huiju.weixin.WeixinServer;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import org.apache.log4j.Logger;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.SpringApplicationConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.web.WebAppConfiguration;

import com.huiju.weixin.WeixinServer.model.KeyTb;
import com.huiju.weixin.WeixinServer.model.LockKeyTb;
import com.huiju.weixin.WeixinServer.model.UserLockTb;
import com.huiju.weixin.WeixinServer.service.LockKeyService;
import com.huiju.weixin.WeixinServer.service.UserLockService;
import com.huiju.weixin.WeixinServer.util.IdGen;
import com.huiju.weixin.WeixinServer.util.ImportDataToExcel;

import jxl.write.WriteException;
import jxl.write.biff.RowsExceededException;
import me.chanjar.weixin.common.exception.WxErrorException;


@RunWith(SpringJUnit4ClassRunner.class)
@SpringApplicationConfiguration(TomcatSslApplication.class)
@WebAppConfiguration
public class UserLockServiceTest {

	@Autowired
	private UserLockService userLockService;
	
	@Autowired
	private LockKeyService lockKeyService;
	private Logger logger = Logger.getLogger(UserLockServiceTest.class);
	
	//@Test
	public void test(){
		String openId="123";
		String deviceId="sdffki_123123_2";
		List<UserLockTb> list = userLockService.getLockByOpenIdAndDeviceId(openId, deviceId);
		logger.debug(list);
	}
	
	//@Test
	public void testTransactional(){
		String openId = "111";
		String lockId = "111";
		UserLockTb userLockTb = new UserLockTb();
		userLockTb.setLockId(lockId);
		userLockTb.setOpenId(openId);
		int i = userLockService.bindDevice(userLockTb);
		logger.debug("事务处理:改变的行数："+i);
	}
	
	//@Test
	public void testDeleteUserLock(){
		String openId = "oJ3fKwDDkQ6ykN1RrXOB3rENJrKY";
		String deviceId="gh_127f2e348655_759937fb6e625ec7";
		userLockService.unbindAllLockKey(openId, userLockService.getLockByOpenIdAndDeviceId(openId, deviceId));
	}
	
	//@Test
	public void testFindLockListByDeviceId(){
		String deviceId="gh_127f2e348655_759937fb6e625ec7";
		List<Object>  locks = lockKeyService.findLocksbydeviceId(deviceId);
		LockKeyTb lockkey = (LockKeyTb) locks.get(0);
		logger.debug(lockkey.getLockId());
	}

	//@Test
	public void testlockList(){
		String openId = "oJ3fKwDDkQ6ykN1RrXOB3rENJrKY";
		List<UserLockTb> list = userLockService.getLockByOpenId(openId);
		logger.debug(list);
	}
	//@Test
	public void testaddkey(){
		KeyTb key = new KeyTb();
		key.setState("1");//1启动 2禁止 首次添加 默认启动
		key.setPosition(1);
		key.setId(2);
		LockKeyTb lockkey = new LockKeyTb();
		lockkey.setKeyId("002E003A");
		lockkey.setLockId("12321312312");
		lockKeyService.addkey(key,lockkey);
	}
	//@Test
	public void testremovekey(){
		String lockId = "12321312312";
		String keyId="002E003A";
		KeyTb userLockKeyBean = lockKeyService.getKeyByKeyId(keyId);
		 logger.debug(userLockKeyBean.getId());
		 lockKeyService.deleteKey(lockId,keyId); 
			List<KeyTb> list = lockKeyService.findKeyListByLockId(lockId,1);
			logger.debug(list);
	}
	@Test
	public void testfindkey(){
		String lockId = "12321312312";
		List<KeyTb> list = lockKeyService.findKeyListByLockId(lockId,1);
		logger.debug(list);
	}
	//@Test
	public void testSaveDeviceIdAndQrcode(){
		List<KeyTb> keyList = new ArrayList<KeyTb>();
		for(int i=0;i<3;i++){
			KeyTb key = new KeyTb();
			key.setDeviceId("12312312");
			key.setQrcodeSerial(IdGen.createQrSerial(i+1));
			key.setTicketId("4324232323");
			keyList.add(key);
		}
		try {
			lockKeyService.saveDeviceIdAndQrcode(3, "25549", "D:/wx_device_qrcode.xls");
			//ImportDataToExcel.execute(keyList, "");
		} catch (IOException e) {
			e.printStackTrace();
		} catch (WxErrorException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} 
	}
}
