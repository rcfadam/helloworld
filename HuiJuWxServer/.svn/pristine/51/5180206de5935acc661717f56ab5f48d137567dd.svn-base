angular.module('MyApp.services',[])
.service('UtilsService',function(UtilFactory,$http,$rootScope,$timeout,ModelFactory){
	var self = this;
	self.alertMsg = function(msg){
		   try{
				var alertMsg = UtilFactory.bytesToString(msg);
				mui.toast(alertMsg);
			}catch(e){
				mui.toast("-------异常"+e.message);
			}
	}
	  /**
	    * 远程请求方法
	    * options 是传递的参数 {method:请求方式 GET /POST, url:请求地址 ，params ：请求参数}
	    */
	   self.requestHttp = function(options,successFunc,errorFunc){
			$http({
				method: options.method,
				url: options.url,
				params: options.params
			}).then(successFunc,errorFunc);
	   }
	 self.pullDownRefresh = function(){
		 wx.invoke('getWXDeviceInfos', {'connType':'blue'}, function(res) {
	            ModelFactory.setDeviceListFromWX(res.deviceInfos);
	    		var codeStr = UtilFactory.getQueryString("code");
				$http({
					method: 'GET',
					url: '/getOpenId',
					params: {
						code: codeStr
					}
				}).then(function(resp) {
					var openid = resp.data.open_id;
					ModelFactory.setOpenId(openid);
		    		$http.get("/devicelist?openId=" +ModelFactory.getOpenId()).then(function(resp) {
		    			ModelFactory.setDeviceListFromServer(resp.data.data);
		    			$rootScope.deviceList = ModelFactory.getDeviceList();
		    			$rootScope.$apply();
		    		    mui('#devicelist').pullRefresh().endPulldownToRefresh();
					}, function(resp) {
						mui.toast("锁列表失败1");
					});
				}, function(resp) {
					mui.toast("锁列表失败2");	
					
				});
			});
	 }
	 self.pullUpRefresh = function(){
		 wx.invoke('getWXDeviceInfos', {'connType':'blue'}, function(res) {
	            ModelFactory.setDeviceListFromWX(res.deviceInfos);
	    		var codeStr = UtilFactory.getQueryString("code");
				$http({
					method: 'GET',
					url: '/getOpenId',
					params: {
						code: codeStr
					}
				}).then(function(resp) {
					var openid = resp.data.open_id;
					ModelFactory.setOpenId(openid);
		    		$http.get("/devicelist?openId=" +ModelFactory.getOpenId()).then(function(resp) {
		    			ModelFactory.setDeviceListFromServer(resp.data.data);
						$rootScope.deviceList = ModelFactory.getDeviceList();
						$rootScope.$apply();
						 mui('#devicelist').pullRefresh().endPullupToRefresh(true);
					}, function(resp) {
						mui.toast("锁列表失败1");
					});
				}, function(resp) {
					mui.toast("锁列表失败2");	
					
				});
			});
	 }
	 
	self.init = function(){
		var currentUrl = window.location.href;
		self.reqJsApiParam(currentUrl);
		self.wxReady();
	}
	self.reqJsApiParam = function(currentUrl){
		$http({
			method: 'GET',
			url: '/getSysInfoByUrl',
			params: {
				url:currentUrl
			}
		}).then(function(resp) {
			//mui.toast(JSON.stringify(resp));
			UtilFactory.setSignature(resp.data.signature);
			UtilFactory.setNonceStr(resp.data.noncestr);
			UtilFactory.setTimestamp(resp.data.timestamp);
			self.wxInit(resp.data.timestamp,resp.data.noncestr,resp.data.signature);
		}, function(resp) {
			mui.toast("获取jsapi参数失败"+JSON.stringify(resp));
		});
	}
	self.wxInit = function(timestamp,nonceStr,signature){
		wx.config({
			beta: true,
			debug: false,
			appId:'wxb4ba14562eb9a765',   //测试   huijuwx.com
			//appId: 'wxf410780b57e7f0ad',//正式 live-smart.com.cn
			timestamp: timestamp,
			nonceStr: nonceStr,
			signature:signature,
			jsApiList: ['openWXDeviceLib',
						'closeWXDeviceLib',
						'getWXDeviceInfos', 
						'getWXDeviceTicket', 
						'onReceiveDataFromWXDevice',
						'sendDataToWXDevice', 
						'scanQRCode', 
						'closeWindow']
		});
	}
	
	self.wxReady = function(){
		wx.ready(function() {
			wx.invoke('openWXDeviceLib', {'connType':'blue'}, function(res){
				$rootScope.$broadcast('transfer.initOK', '');
			});
		 
			wx.on('onReceiveDataFromWXDevice', function(res) {
				var recvMsg = window.atob(res.base64Data);  
				recvMsg = UtilFactory.bytesToString(recvMsg);
				var cmdId = recvMsg.substr(0, 4); //取CMD ID
				var resultCode = recvMsg.substr(4, 2); // 取返回码
				var position = recvMsg.substr(6,2);//取钥匙在锁芯的position位置号 
				mui.toast("获取设备消息"+resultCode+"---"+recvMsg+"----cmdId="+cmdId);
				//第二步，接收蓝牙钥匙发送来的消息 来决定钥匙的状态。0x01 /A0 插入钥匙  ，0x02/B1 未插入钥匙   ，0x03/A2钥匙ID非法，非本锁芯对应配置钥匙
				if (cmdId == '0001') {
					var keyState = '';
					if (resultCode == '01') {
						keyState = resultCode;//插入钥匙
						$rootScope.$broadcast('transfer.keyState', keyState); 
					} else if (resultCode == '02') {
						keyState = resultCode;//未插入钥匙
						$rootScope.$broadcast('transfer.keyState', keyState); 
					} else if (resultCode == '03') {
						keyState = resultCode;//钥匙非法
						$rootScope.$broadcast('transfer.keyState', keyState); 
					}
				} else if (cmdId == '0002') {
					if (resultCode == '01') {
						///toaster.info("position="+position);
						$rootScope.$broadcast('transfer.addkeyOK',position);
					} else if (resultCode == '02') {
						$rootScope.$broadcast('transfer.addkeyFailed', "已添加钥匙");
					} else if (resultCode == '03') {
						$rootScope.$broadcast('transfer.addkeyFailed', '位号已满');
					}
				} else if (cmdId == '0003') {
					if (resultCode == '01') {
						$rootScope.$broadcast('transfer.deletekeyOK');
					} else if (resultCode == '02') {
						$rootScope.$broadcast('transfer.deletekeyFailed', '删除钥匙失败');
					}
				} else if (cmdId == '0004') {
					if (resultCode == '01') {
						$rootScope.$broadcast('transfer.enablekeyOK');
					} else if (resultCode == '02') {
						$rootScope.$broadcast('transfer.enablekeyFailed', '启用钥匙失败');
					}
				} else if (cmdId == '0005') {
					if (resultCode == '01') {
						$rootScope.$broadcast('transfer.disablekeyOK');
					} else if (resultCode == '02') {
						$rootScope.$broadcast('transfer.disablekeyFailed', '禁用钥匙失败');
					}
				}else if(cmdId=='0006'){
					$rootScope.$broadcast('transfer.batteryOk',recvMsg);
				}else if(cmdId=='0007'){
					$rootScope.$broadcast('transfer.versionOk',recvMsg);
				} 
			});
		});

		wx.error(function(res){
	    	mui.toast("wx.error:" + JSON.stringify(res));
		});
	}
	 
})
.factory('UtilFactory',function(){
	var signature = '';//微信签名
	var noncestr = ''; //微信随机数
	var timestamp = ''; //微信时间戳
	return {
		setSignature:function(data){
			signature = data;
		},
		getSignature:function(){
			return signature;
		},
		setNonceStr:function(data){
			noncestr = data;
		},
		getNonceStr:function(){
			return noncestr;
		},
		setTimestamp:function(data){
			timestamp = data;
		},
		getTimestamp:function(){
			return timestamp;
		},
		getQueryString: function(str) {
			
			var reg = new RegExp("(^|&)"+ str +"=([^&]*)(&|$)");
			var r = window.location.search.substr(1).match(reg);
			if(r!=null) {
				return  unescape(r[2]); 
			}
			return null;
		},
		setBodyTitle: function(data) {
			var $body = $('body');
  			document.title = data;
  			var $iframe = $("<iframe style='display:none;' src='/favicon.ico'></iframe>");
  			$iframe.on('load',function() {
    			setTimeout(function() {
      				$iframe.off('load').remove();
    			}, 0);
  			}).appendTo($body);
		},
		bytesToString: function(data) {
			var str = '';
			for (var i = 0; i < data.length; i++) {
				var temp = data.charCodeAt(i).toString(16).toUpperCase();
				if (temp.length == 1) {
					temp = '0' + temp;
				}
				str += temp;
			}
			return str;
		},
		stringToBytes: function(data) {
			var pos = 0;
			var len = data.length;
			if (len % 2 != 0) {return null;}
			len /= 2;
			var hexArray = new Array();
			for (var i = 0; i < len; i++) {
				var s = data.substr(pos, 2);
				var v = parseInt(s, 16);
				hexArray.push(v);
				pos += 2;
			}
			return hexArray;
		}
	}
})

.factory('ModelFactory', function(){
	var self = this;
	var openid = '';
	var deviceList = {};
	var selectedDevice = {};
	var selectedKey = '';
	var lockId = "";
	var deviceListFromWX = {};
	var curKey =null;//当前连接的管理钥匙
	var deviceId = "";//成功发送消息给设备后缓存的设备id
	return {
		setOpenId: function(data) {
			openid = data;
		},
		getOpenId: function() {
			return openid;
		},
		setDeviceListFromWX: function(data) {
			deviceListFromWX = data;
        },
        setDeviceListFromServer: function(data) {
        	 deviceList = data;
        },
        removeDevice: function(data) {
        	/*delete deviceList[data];*/
        	 for (var i = 0; i < deviceList.length; i++) {
				var device = deviceList[i];
				if(device.lockId==data){
					deviceList.splice(i,1);
				} 
			}
        },
        updateKeyState:function(data){
        	for (var i = 0; i < deviceList.length; i++) {
				var device = deviceList[i];
				var keyList = device.keyList;
				for (var j = 0; j < keyList.length; j++) {
					if(keyList[j].keyId == data.keyId){
						keyList[j].state = data.state;
					}
				}
			}
        },
        removeKey:function(data){
        	for (var i = 0; i < deviceList.length; i++) {
				var device = deviceList[i];
				var keyList = device.keyList;
				for (var j = 0; j < keyList.length; j++) {
					if(keyList[j].keyId == data.keyId){
						keyList.splice(j,1);
					}
				}
			}
        },
        insertKey:function(key,lockId){
        	for (var i = 0; i < deviceList.length; i++) {
				var device = deviceList[i];
				var keyList = device.keyList;
				if(lockId==device.lockId){
					keyList.push(key);
				} 
			}
        },
		getDeviceList: function() {
			if(deviceList.length>0){
				for (var i = 0; i < deviceList.length; i++) {
					var device = deviceList[i];
					var connectionCount = 0;
					var keyList = device.keyList;
					device.deviceId = "";
					for (var j = 0; j < keyList.length; j++) {
						if(keyList[j].state=="2"){
							keyList[j].stateStr = "已停用";
						}else if(keyList[j].state=="1"){
							keyList[j].stateStr = "已启用";
						}else{
							keyList[j].stateStr = "已停用";
						}
						if(keyList[j].type==1){
							for (var k = 0; k < deviceListFromWX.length; k++) {
								if(keyList[j].deviceId==deviceListFromWX[k].deviceId){
									connectionCount = deviceListFromWX[k].state=="connected"?++connectionCount:connectionCount;
								    device.deviceId+=deviceListFromWX[k].state=="connected"?deviceListFromWX[k].deviceId+",":"";
								    keyList[j].connectStatus = deviceListFromWX[k].state=="connected"?"已连接":"未连接";
								}
							}
							device.state = "已连接"+connectionCount+"个蓝牙设备"; 
							//toaster.info("----"+device.deviceId);
						}
					}
				}
			}
			return deviceList;
		},
		compareDeviceId:function(deviceIds,deviceId){
			//dtoaster.info("indexOf="+deviceIds.indexOf(deviceId));
			if(deviceId==""||deviceId==null||deviceId==undefined||deviceId=="undefined"){
				return false;
			}
			if(deviceIds==""||deviceIds==null||deviceIds==undefined||deviceIds=="undefined"){
				return false;
			}
			return new RegExp(deviceId).test(deviceIds);
		},
		getCurKeyByDeviceId:function(data){
			if(deviceList.length>0){
				for (var i = 0; i < deviceList.length; i++) {
					var device = deviceList[i];
					var keyList = device.keyList;
					for (var j = 0; j < keyList.length; j++) {
						if(keyList[j].deviceId==data){
							curKey = keyList[j];
						} 
					}
				}
			}
			return curKey;
		},
		setSelectedDevice: function(data) {
			selectedDevice = data;
		},
		getSelectedDevice: function() {
			return selectedDevice;
		},
		setSelectedKey: function(data) {
			selectedKey = data;
		},
		getSelectedKey: function() {
			return selectedKey;
		},
		setSelectedLockId:function(data){
			lockId = data;
		},
		getSelectedLockId:function(){
			return lockId;
		},
		getDefaultDeviceId:function(){
			return deviceId;
		},
		setDefaultDeviceId:function(data){
			deviceId = data;
		},
		sendDataToWxDevice:function(deviceId,base64Data){
	    	 
			wx.invoke('sendDataToWXDevice', {"deviceId": deviceId,"base64Data":base64Data}, function(res) {
			    if (res.err_msg =="sendDataToWXDevice:ok") {  
			    	 mui.toast('消息发送成功');
			    } else {  
			        mui.toast('消息发送失败'+JSON.stringify(res));
			    }       
			});
	    },
	    /**
		 * 创建消息
		 * {@link cmdId}} 格式 0x 开头的消息  比如 0x01  0x02 0x03 0x04 ...
		 * {@link Position} 位置号  为0 不存在
		 * {@link keyId} 钥匙id  为null  或 "" 不存在
		 */
		createmsg :function(cmdId,position,keyId){
			 var msg = String.fromCharCode(0x00)+String.fromCharCode(cmdId);
			if(position>0){
				msg += String.fromCharCode(parseInt(position,10));
			}
			if(keyId!=null&&keyId!=""){
				var keyIdData = UtilFactory.stringToBytes(keyId);
				for (var i=0; i<keyIdData.length; i++) {
					msg += String.fromCharCode(keyIdData[i]);
				}
			}
			return msg;
		},
		confirmBtn:function(message,title,success){
			var btnArray = ['取消', '确认'];
			mui.confirm(message, title, btnArray, success);
		},
		showWaiting:function(title,options){
			if(plus!=null){
				plus.nativeUI.showwating(title,options);
			}
		},
		closeWaiting:function(){
			if(plus==null){
				return ;
			}
			plus.nativeUI.closeWaiting();
		}
	}
})
